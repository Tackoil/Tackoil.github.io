<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.61">
    <link rel="icon" href="/assets/avatar.png"><link rel="apple-touch-icon" href="/assets/avatar.png"><title>Axios 中关于 Promise 的使用与理解 | Tackoil's WebSite</title><meta name="description" content="最近在看了 Axios 的源码。在已有 XMLHttpRequest 的情况下，Axios 做了哪些改进吸引大家使用？抱着这样的想法尝试理解与阅读 Axios 仓库。">
    <link rel="preload" href="/assets/style-fd35025c.css" as="style"><link rel="stylesheet" href="/assets/style-fd35025c.css">
    <link rel="modulepreload" href="/assets/app-23936c61.js"><link rel="modulepreload" href="/assets/framework-806b4cee.js"><link rel="modulepreload" href="/assets/axios-promise.html-ba990404.js"><link rel="modulepreload" href="/assets/axios-promise.html-17f0856e.js"><link rel="prefetch" href="/assets/index.html-eb8c85a2.js" as="script"><link rel="prefetch" href="/assets/about.html-91f1e27d.js" as="script"><link rel="prefetch" href="/assets/links.html-2eb2e38a.js" as="script"><link rel="prefetch" href="/assets/2021-winter-solstice.html-61365fa2.js" as="script"><link rel="prefetch" href="/assets/2021a10.html-5477114f.js" as="script"><link rel="prefetch" href="/assets/2021s12.html-6be15c11.js" as="script"><link rel="prefetch" href="/assets/2022-winter-solstice.html-f058b686.js" as="script"><link rel="prefetch" href="/assets/2023-summer-solstice.html-7f466ccb.js" as="script"><link rel="prefetch" href="/assets/2023-winter-solstice.html-1f029375.js" as="script"><link rel="prefetch" href="/assets/2024-summer-solstice.html-aeb7d026.js" as="script"><link rel="prefetch" href="/assets/css-hacky.html-ee503659.js" as="script"><link rel="prefetch" href="/assets/js-destructuring-assignment.html-5e0ba172.js" as="script"><link rel="prefetch" href="/assets/linguistics.html-47836ab6.js" as="script"><link rel="prefetch" href="/assets/metrics.html-095ae73f.js" as="script"><link rel="prefetch" href="/assets/nn0.html-e511743b.js" as="script"><link rel="prefetch" href="/assets/oped-view.html-994e76b2.js" as="script"><link rel="prefetch" href="/assets/oped-view2.html-a1913a70.js" as="script"><link rel="prefetch" href="/assets/pcrtest.html-7e5c31c2.js" as="script"><link rel="prefetch" href="/assets/repeater.html-fd93589d.js" as="script"><link rel="prefetch" href="/assets/404.html-e0575d4e.js" as="script"><link rel="prefetch" href="/assets/index.html-46501958.js" as="script"><link rel="prefetch" href="/assets/about.html-20b74c46.js" as="script"><link rel="prefetch" href="/assets/links.html-27ee435e.js" as="script"><link rel="prefetch" href="/assets/2021-winter-solstice.html-f97249ca.js" as="script"><link rel="prefetch" href="/assets/2021a10.html-8afbdffe.js" as="script"><link rel="prefetch" href="/assets/2021s12.html-d4314263.js" as="script"><link rel="prefetch" href="/assets/2022-winter-solstice.html-68674990.js" as="script"><link rel="prefetch" href="/assets/2023-summer-solstice.html-16180a1a.js" as="script"><link rel="prefetch" href="/assets/2023-winter-solstice.html-c9725ad2.js" as="script"><link rel="prefetch" href="/assets/2024-summer-solstice.html-dc58a49e.js" as="script"><link rel="prefetch" href="/assets/css-hacky.html-0007e958.js" as="script"><link rel="prefetch" href="/assets/js-destructuring-assignment.html-c91fe4c1.js" as="script"><link rel="prefetch" href="/assets/linguistics.html-38faa69f.js" as="script"><link rel="prefetch" href="/assets/metrics.html-2f0257fa.js" as="script"><link rel="prefetch" href="/assets/nn0.html-96851849.js" as="script"><link rel="prefetch" href="/assets/oped-view.html-691ed83c.js" as="script"><link rel="prefetch" href="/assets/oped-view2.html-7fefe27a.js" as="script"><link rel="prefetch" href="/assets/pcrtest.html-593db13e.js" as="script"><link rel="prefetch" href="/assets/repeater.html-45a87442.js" as="script"><link rel="prefetch" href="/assets/404.html-509ce1be.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><header class="nav-bar"><div class="nav-bar-container"><span class="nav-bar__title">Tackoil&#39;s WebSite</span><div class="button-group"><!--[--><button class="button-group__button"><i class="iconfont icon-home"></i><div class="shrink-content" style="width:40px;"><div><!--[--><span>首页</span><!--]--></div></div></button><button class="button-group__button"><i class="iconfont icon-user"></i><div class="shrink-content" style="width:40px;"><div><!--[--><span>关于</span><!--]--></div></div></button><button class="button-group__button"><i class="iconfont icon-link"></i><div class="shrink-content" style="width:40px;"><div><!--[--><span>友链</span><!--]--></div></div></button><!--]--></div></div></header><div class="head-pic" style="transform:translateY(NaNpx);"><div class="head-pic__title" style="transform:translateY(-0vh);">Axios 中关于 Promise 的使用与理解</div><div class="head-pic__mask"></div><div class="head-pic__pic" style="filter:blur(0px);background-image:url(https://wonder-egg-priority.com/assets/img/top/main/visual.jpg);"></div></div><div class="page-card__container" style="transform:translateY(-0vh);margin-bottom:-0vh;"><div class="page-card"><!--[--><!--[--><!--[--><div class="post-title">Axios 中关于 Promise 的使用与理解</div><div class="markdown-body markdown-body--indent"><p>最近在看了 Axios 的源码。在已有 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer"><code>XMLHttpRequest</code></a> 的情况下，Axios 做了哪些改进吸引大家使用？抱着这样的想法尝试理解与阅读 Axios 仓库。</p><p><a href="https://github.com/axios/axios" target="_blank" rel="noopener noreferrer">Link: axios/axios</a><img src="https://opengraph.githubassets.com/ddb54613cedd4ca9c7c32776111dc36f7622b78611708ca86fa850b692919aec/axios/axios" alt=""></p><!--more--><h1 id="axios-的基本组成" tabindex="-1"><a class="header-anchor" href="#axios-的基本组成" aria-hidden="true">#</a> Axios 的基本组成</h1><blockquote><p>这里的<strong>基本组成</strong>是指 <code>lib</code> 文件夹下的内容。其他文件夹主要是用来存放示例文件、测试文件、开源相关说明文件等。</p></blockquote><p>首先，观察目录结构。每个模块的作用可以通过文件夹的名字了解个大概。整个结构也非常整洁，还是很适合初学者（比如笔者）阅读的。</p><ul><li><code>adapters/</code> 为提供 HTTP 请求的适配器。用以支持 node.js 与 浏览器发送 HTTP 请求。</li><li><code>cancel/</code> 负责实现请求取消的功能。包含了将要废除的 Cancel Token 模式的实现。</li><li><code>core/</code> 为核心内容，主要负责加载配置文件、处理拦截器、发送请求等功能。</li><li><code>defaults/</code> 存放一些默认的配置文件。</li><li><code>env/</code> 自动生成，主要用来标识版本。</li><li><code>helpers/</code> 各种各样的帮助文件，显然里面有一些功能已经成为 JavaScript 的内置功能了，交给 Babel 也未尝不可。</li><li><code>axios.js</code> 入口文件。除了暴露 API 以外，还有一小部分逻辑用来实现非实例化直接使用的功能。</li><li><code>utils.js</code> 一些小工具函数。感觉也有不少其实可以直接调用 JavaScript 的内置函数。主要还是减少工作环境的影响。</li></ul><p>Axios 既然被称之为<strong>基于Promise的网络请求库</strong>，其对于 JavaScript 中 <code>Promise</code> 的理解也应该是非常透彻的。本文主要针对笔者所认为两处对 <code>Promise</code> 特性运用较为充分的两部分进行介绍。</p><p>在开始下文之前，还需要介绍一下 Axios 是通过 <code>config</code> 控制的。这个 <code>config</code> 除了 <code>url</code> 以外，还包含 <code>headers</code>、<code>proxy</code> 等其他配置。可以认为 Axios 实例如果传入相同的 <code>config</code>，就会执行完全一致的操作。</p><h1 id="axios-中关于拦截器的实现" tabindex="-1"><a class="header-anchor" href="#axios-中关于拦截器的实现" aria-hidden="true">#</a> Axios 中关于拦截器的实现</h1><h2 id="axios-中的拦截器" tabindex="-1"><a class="header-anchor" href="#axios-中的拦截器" aria-hidden="true">#</a> Axios 中的拦截器</h2><p>拦截器的作用是在<strong>发送请求前</strong>与<strong>收到响应后</strong>分别对请求与响应进行处理，从而实现一些便捷操作。例如 JWT 权限验证、响应数据的分析等。拦截器使用如下方式定义：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 添加请求拦截器</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在发送请求之前做些什么</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span> <span class="token comment">// 一定要返回 config，很重要</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对请求错误做些什么</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加响应拦截器</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2xx 范围内的状态码都会触发该函数。</span>
    <span class="token comment">// 对响应数据做点什么</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span> <span class="token comment">// 一定要返回 response，很重要</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 超出 2xx 范围的状态码都会触发该函数。</span>
    <span class="token comment">// 对响应错误做点什么</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对照 <code>core/InterceptorManager.js</code>，可以发现还包含了一个 <code>options</code> 选项，为拦截器提供特殊功能。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token class-name">InterceptorManager</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fulfilled<span class="token punctuation">,</span> rejected<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 存放拦截器的数组</span>
    <span class="token literal-property property">fulfilled</span><span class="token operator">:</span> fulfilled<span class="token punctuation">,</span>
    <span class="token literal-property property">rejected</span><span class="token operator">:</span> rejected<span class="token punctuation">,</span>
    <span class="token literal-property property">synchronous</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>synchronous <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">runWhen</span><span class="token operator">:</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>runWhen <span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回 index 以进行拦截器的移除</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>了解了这些，就可以仔细看看 Axios 是如何实现拦截器的。</p><p>首先，对请求拦截器与响应拦截器进行处理。判断是否包含异步拦截器、跳过部分拦截器。主要注意的是，请求拦截器中后绑定的放在队列的前面（<code>unshift</code>），响应拦截器则相反（<code>push</code>）。其中，Axios 默认所有请求拦截器都是<strong>异步的</strong>，即<code>interceptor.synchronous = false;</code>。</p><p>拦截器列表由偶数个函数构成，每<strong>两个函数</strong>一组。分别表示一个拦截器的执行函数与错误处理函数。类似于 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then" target="_blank" rel="noopener noreferrer"><code>Promise.prototype.then()</code></a> 的入参。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// core/Axios.js</span>
  <span class="token comment">// filter out skipped interceptors</span>
  <span class="token keyword">var</span> requestInterceptorChain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> synchronousRequestInterceptors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">unshiftRequestInterceptors</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> interceptor<span class="token punctuation">.</span>runWhen <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> interceptor<span class="token punctuation">.</span><span class="token function">runWhen</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 过滤</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    synchronousRequestInterceptors <span class="token operator">=</span> synchronousRequestInterceptors <span class="token operator">&amp;&amp;</span> interceptor<span class="token punctuation">.</span>synchronous<span class="token punctuation">;</span> <span class="token comment">// 判断是否都为同步</span>

    requestInterceptorChain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意顺序：unshift</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> responseInterceptorChain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">pushResponseInterceptors</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    responseInterceptorChain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> interceptor<span class="token punctuation">.</span>rejected<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意顺序：push</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后，Axios 针对异步请求拦截器与同步请求拦截器分情况进行了处理。其中如果所有请求拦截器都是同步的，则循环执行更新 <code>config</code> 即可。下面介绍包含异步的拦截器链进行介绍。</p><ol><li>把主请求（指除去拦截器以外的请求）与一个<strong>空元素</strong>放在列表中间。然后将请求拦截器列表放在前面，把响应拦截器列表放在后面。</li><li>调用 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve" target="_blank" rel="noopener noreferrer"><code>Promise.resolve()</code></a> 函数，生成一个 <code>Promise</code> 对象。</li><li>将拦截器列表中的元素两个一组，放入 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/then" target="_blank" rel="noopener noreferrer"><code>then</code></a> 中，并将返回的新 <code>Promise</code> 替代原始的 <code>Promise</code>。</li><li>返回最终得到的 <code>Promise</code> 链。</li></ol><p>将上述 Promise 链具体化，如下图所示。</p><p><img src="/assets/promise-chain-2b152a48.jpg" alt="Promise 链"></p><blockquote><p>您可能发现了，这里面<strong>请求拦截器</strong>的 <code>onRejected</code> 好像有些诡异。是的，笔者也是写到这里才发现这个问题，现已提交 <a href="https://github.com/axios/axios/issues/4537" target="_blank" rel="noopener noreferrer">issue</a>。</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// core/Axios.js</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>synchronousRequestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>dispatchRequest<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> requestInterceptorChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chain <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>responseInterceptorChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

    promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Promise 链中所有在主请求前的 Promise 传递修改 config，在主请求后的 Promise 传递并修改 response。这样就完成了对请求和响应的拦截。那么 <code>Promise.resolve()</code> 与 <code>Promise.prototype.then()</code> 是如何实现这个可以把同步请求也包装进 Promise 链的功能的？</p><h2 id="promise-resolve" tabindex="-1"><a class="header-anchor" href="#promise-resolve" aria-hidden="true">#</a> Promise.resolve()</h2><p>参考 MDN 中关于 <code>Promise.resolve()</code> 的描述，可以发现其作用就是返回一个新的 <code>Promise</code>。但根据入参的类型不同行为有一定区别。</p><ol><li>如果是另一个 <code>Promise</code>，则返回这个 <code>Promise</code></li><li>如果是一个含有 <code>then</code> 方法的对象，则会尝试执行该 <code>then</code> 方法，根据执行结果返回对应状态的 <code>Promise</code>。（类似于<code>new Promise(then)</code>）<strong>这里会递归执行所有嵌套的 <code>then</code>，直到 <code>fuilfilled</code> 或者 <code>rejected</code></strong>。</li><li>其他情况则返回一个新的 <code>Promise</code> ，并且这个 <code>Promise</code> 将处于 <code>fulfilled</code> 状态，<code>fulfilled</code> 值为入参。</li></ol><p>可以发现这个函数非常适合将一个对象包装成 Promise，并作为 Promise 链的开头使用。</p><p>如果对上述描述还有困惑的话，可以参考下面的简易 Polyfill。<s>（不过都有 <code>Promise</code> 了，还能没有 <code>Promise.resolve()</code> 么）</s></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token comment">// 情况1，入参为 Promise，则直接返回该 Promise</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 情况2，入参对象含有 then 方法，则执行该 then 方法</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 情况3，返回 fulfilled 的 Promise</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于这种含有 <code>then</code> 方法的对象，可以称之为 <code>thenable</code>。可以认为是一个 <strong>弱化版</strong> 的 <code>Promise</code>，但没有JavaScript解释器的 <strong>微任务</strong> 的保障。为了加深对 <code>thenable</code> 的印象，来看下面这个例子。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> p_thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve_outter</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">resolve_outter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve_middle</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve_middle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve_inner</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// throw Error(&quot;Rejected in Inner thenable.&quot;);</span>
            <span class="token function">resolve_inner</span><span class="token punctuation">(</span><span class="token string">&quot;Fulfilled in Inner thenable.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p_promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p_thenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
p_promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FULFILLED with:&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;REJECTED with:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在注释和取消注释 <code>throw</code> 语句之后，console 中分别输出以下内容。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>FULFILLED with: Fulfilled in Inner thenable.
REJECTED with: Error: Rejected in Inner thenable.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果根据上文给出的 Polyfill 理解 <code>Promise.resolve()</code> 的话，输出应该都是 <code>FULFILLED with: {then: function ...}</code>，因为只调用了两次 <code>then</code>，第三个对象应该会作为 <code>fulfilled</code> 的值传给 <code>value</code>。这就说明 <code>Promise.resolve()</code> 会尝试解析 <code>thenable</code> 的最终结果，并把最终结果包装成 <code>Promise</code> 进行返回。</p><p>因此如果使用 <code>thenable</code> 特性的时候，<strong>不要将自身作为 <code>fulfilled</code> 的值</strong>，否则解释器会死循环。（不过应该没有多人想用 <code>thenable</code> 吧。）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>  <span class="token comment">// Will lead to infinite recursion.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>PS: 其实尝试执行的话，发现上面 <code>Promise.resolve()</code> 的 Polyfill 也是正确的。可能是因为 <code>Promise</code> 构造函数在入参（执行器）执行过程中调用的 <code>resolve()</code> 与 <code>Promise.resolve()</code> 的功能相同。</p></blockquote><h2 id="promise-prototype-then" tabindex="-1"><a class="header-anchor" href="#promise-prototype-then" aria-hidden="true">#</a> Promise.prototype.then()</h2><p>如果使用过 Axios 的话，那对于 <code>Promise.prototype.then()</code> 应该不陌生了。其作为构建 <code>Promise</code> 链的胶水，传入两个函数分别处理<strong>前一个</strong> <code>Promise</code> 处于 <code>fulfilled</code> 或者 <code>rejected</code> 状态下的执行内容。然而正因为<code>then</code> <strong>返回值</strong>的特性，才使得其可以作为构建 <code>Promise</code> 链的胶水使用。</p><blockquote><p>下文中的执行函数指的是 <code>onFulfilled</code> 或 <code>onRejected</code>。</p></blockquote><ol><li>当执行函数返回一个值，则 <code>then</code> 函数返回一个 <code>fulfilled</code> 状态的 <code>Promise</code>，<code>fulfilled</code> 值为执行函数的返回值</li><li>当执行函数不返回任何值，则 <code>then</code> 函数返回一个 <code>fulfilled</code> 状态的 <code>Promise</code>, <code>fulfilled</code> 值为 <code>undefined</code></li><li>当执行函数抛出一个错误，则 <code>then</code> 函数返回一个 <code>rejected</code> 状态的 <code>Promise</code>，<code>rejected</code> 值为该错误。</li><li>当执行函数返回一个 <code>Promise</code>，则 <code>then</code> 函数返回该 <code>Promise</code>。</li></ol><p>可以发现 <code>Promise.prototype.then()</code> 也有包装非 <code>Promise</code> 的作用。那么 <code>Promise.prototype.then()</code> 会和 <code>Promise.resolve()</code> 一样尝试处理 <code>thenable</code> 么？答案是会的。就不在下文举例说明啦。</p><h1 id="axios-中关于取消的实现" tabindex="-1"><a class="header-anchor" href="#axios-中关于取消的实现" aria-hidden="true">#</a> Axios 中关于取消的实现</h1><h2 id="axios-中的-canceltoken" tabindex="-1"><a class="header-anchor" href="#axios-中的-canceltoken" aria-hidden="true">#</a> Axios 中的 CancelToken</h2><p>其实当本文撰写过程中，Axios 已经声明将 <code>CancelToken</code> 废弃（Deprecated）。不过源码中还包含这部分功能的实现，还是值得一看的。</p><p>先简单介绍一下怎么使用 CancelToken 取消一个正在执行的请求。使用 <code>CancelToken.source()</code> 工厂函数获得一个 token 操作对象 <code>source</code>。将 token 传入 config 中即可控制该请求是否需要取消。取消时执行 <code>source.cancel()</code> 即可。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> CancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken<span class="token punctuation">;</span>
<span class="token keyword">const</span> source <span class="token operator">=</span> CancelToken<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user/12345&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;new name&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">cancelToken</span><span class="token operator">:</span> source<span class="token punctuation">.</span>token
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// cancel the request (the message parameter is optional)</span>
source<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">&#39;Operation canceled by the user.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过，工厂函数方案其实是对 CancelToken 的一个封装。工厂函数如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// lib/cancel/CancelToken.js</span>
CancelToken<span class="token punctuation">.</span><span class="token function-variable function">source</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> cancel<span class="token punctuation">;</span>
  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cancel <span class="token operator">=</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">token</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
    <span class="token literal-property property">cancel</span><span class="token operator">:</span> cancel
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>发现 <code>cancel</code> 函数通过 <code>CancelToken</code> 构造函数执行入参函数的方式暴露的，<s>可以说是非常扭曲了</s>。不过概括起来，CancelToken 对象为用户提供了两个元素：<code>token</code> 与 <code>cancel</code> 函数。</p><p>先观察 <code>cancel</code> 函数，执行该函数会给 <code>reason</code> 赋值，并传入 <code>resolvePromise</code> 函数。通过判断 <code>reason</code> 是否已经存在来判断 <code>cancel</code> 函数是否已经被执行。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// lib/cancel/CancelToken.js</span>
  <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Cancellation has already been requested</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    token<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个 <code>resolvePromise</code> 是用来 resolve 一个 <code>Promise</code> 的。<s>（和没说一样）</s> 具体而言，使用外部变量将 <code>Promise</code> 中的执行器入参暴露出来，从而实现在任意位置控制这个 Promise 的状态。后面会详细介绍 <code>Promise</code> 构造器的工作方式。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// lib/cancel/CancelToken.js</span>
  <span class="token keyword">var</span> resolvePromise<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">promiseExecutor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolvePromise <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有了这个“扳机”，怎样实现请求的取消呢？先看看这个“扳机”后面都链接了什么内容。可以发现 Axios 在这个“扳机”后面调用了 <code>Promise.prototype.then()</code> 函数。由于“扳机”一直处于 <code>pending</code> 状态，<code>then</code> 的入参函数也将不会执行。阅读后可以发现这个函数主要执行与该 <code>token</code> 绑定的每个函数。这属于设计模式中的 <strong>观察者模式</strong> 。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// lib/cancel/CancelToken.js</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cancel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">.</span>_listeners<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> i<span class="token punctuation">;</span>
    <span class="token keyword">var</span> l <span class="token operator">=</span> token<span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      token<span class="token punctuation">.</span>_listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>cancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    token<span class="token punctuation">.</span>_listeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后面就不过多展示源码了，主要包含以下几部分内容：</p><ul><li>实现订阅函数与取消订阅函数</li><li>在请求发送前、请求发送后判断是否已经执行取消操作</li><li>与 <code>http</code> 或 <code>xhr</code> 联动，实现取消功能。</li></ul><p>不过还有一个额外的问题，在提交历史和其他介绍文章中也没有看到合适的解释：</p><blockquote><p>在 <code>lib/cancel/CancelToken.js</code> 中，<code>CancelToken</code> 构造函数内。在上述执行 <code>then</code> 函数的操作后，又新写了一个 <code>then</code> 方法。不知道这个 <code>then</code> 方法是用来做什么的。</p></blockquote><p>如果有了解的同学希望不吝赐教。</p><h2 id="promise-构造器" tabindex="-1"><a class="header-anchor" href="#promise-构造器" aria-hidden="true">#</a> Promise() 构造器</h2><p>这部分在 MDN 上的中文文档有我参与翻译的部分。当时也主要是因为原始版本与英文版本相距甚远，于是按照英文版本的文档进行了完善。笔者认为阅读过该文档，应该会对 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/Promise" target="_blank" rel="noopener noreferrer">Promise() 构造器</a> 及其入参函数有进一步的理解。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>入参函数 <code>executor</code> 决定了这个新 Promise 的行为是怎样的。<code>executor</code> 有两个参数构成，当然这两个参数传不传都不会报错，但如果连 <code>onFulfilled</code> 都不传的话，这个新 Promise 将会永久处于 <code>pendding</code> 状态。</p><blockquote><p>这里使用与 MDN 文档上不同的入参命名方式，主要是考虑到与上文的一致性。</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 通常是一些异步操作，同步操作也可以</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如何改变这个 Promise 的状态呢？有以下三种情况：</p><ul><li>调用 <code>onFulfilled(value)</code>，新 Promise 为 <code>fulfilled</code>，<code>fulfilled</code> 值为 <code>value</code>。</li><li>调用 <code>onRejected(reason)</code>，新 Promise 为 <code>rejected</code>，<code>rejected</code> 值为 <code>reason</code>。</li><li><code>onFulfilled</code> 函数出现异常，新 Promise 为 <code>rejected</code>，<code>rejected</code> 值为该异常。</li></ul><p>此外 <code>executor</code> 自身的返回值将会被忽略。所以 <code>Promise()</code> 构造器的主要作用是将一个异步操作包装成 Promise。</p><h1 id="结语" tabindex="-1"><a class="header-anchor" href="#结语" aria-hidden="true">#</a> 结语</h1><p>本文主要还是笔者个人的想法居多，以学习的角度详细介绍了 Axios 库中两个与 Promise 应用相关的功能，从而深入理解 Promise 的工作原理和部分函数的实现。希望以后还可以产出这样的文章与各位共勉。</p><h1 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> Reference</h1><blockquote><ul><li>其实写这篇文章的时候主要参考的是 <a href="https://axios-http.com/zh/docs/intro" target="_blank" rel="noopener noreferrer">官方文档</a> 与 <a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer">MDN 文档</a> 。下面列出来的主要是学习 Axios 源码时所参考的文章。</li><li>另外，还有一些关于用语的内容，也写在这里了。针对 “fulfilled/rejected with ...” 这种表达，笔者采用了 fulfilled/rejected 的值为 ... 。都指该 Promise 后接 then 的两个入参函数（onFulfilled/onRejected）的入参。（感觉不太好翻译这个概念。）</li></ul></blockquote><ul><li><a href="https://juejin.cn/post/6844903824583294984" target="_blank" rel="noopener noreferrer">Axios 源码解析 - 掘金</a></li></ul></div><!--]--><!--]--><!--]--></div></div><footer class="footer" data-v-e3fc0134><div class="footer-content" data-v-e3fc0134> Base VuePress by <a href="https://github.com/Tackoil/vuepress-theme-anemos" data-v-e3fc0134>Anemos</a></div></footer><!--]--><!--]--></div>
    <script type="module" src="/assets/app-23936c61.js" defer></script>
  </body>
</html>
